<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFF POS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General Styles */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }

        /* --- RECEIPT DESIGN --- */
        .receipt-font { 
            font-family: 'Arial Narrow', Arial, sans-serif; 
            font-size: 11px; 
            line-height: 1.3;
            color: black;
        }
        
        /* Default screen view width */
        .receipt-container {
            width: 72mm; 
            margin: 0 auto; 
            background: white; 
            padding: 2mm 1mm; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            overflow: hidden;
            box-sizing: border-box; /* Ensures padding doesn't increase width */
        }

        .shop-header { text-align: center; margin-bottom: 5px; }
        .shop-name { font-weight: bold; font-size: 14px; text-transform: uppercase; }
        .shop-details { font-size: 10px; color: #000; }

        .info-row { display: flex; justify-content: space-between; font-size: 10px; font-weight: bold; }

        .customer-section { font-size: 10px; margin-top: 5px; margin-bottom: 5px; line-height: 1.4; }
        .customer-label { font-weight: bold; }

        table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 5px; }
        .table-header td { font-weight: bold; border-top: 1px solid #000; border-bottom: 1px solid #000; padding: 3px 0; text-transform: capitalize; }
        .item-row td { padding: 2px 0; vertical-align: top; }

        .totals-section { margin-top: 5px; border-top: 1px solid #000; padding-top: 5px; font-size: 11px; text-align: right; }
        .footer-msg { text-align: center; margin-top: 10px; font-size: 9px; border-top: 1px solid #ccc; padding-top: 5px; }

        /* --- PRINT STYLES FIXED --- */
        @media print {
            body { 
                background: white; 
                margin: 0 !important; 
                padding: 0 !important; 
            }
            .no-print { display: none !important; }
            
            body.printing-history #view-history { display: none !important; }
            body.printing-history #view-print { display: block !important; visibility: visible !important; }
            
            /* Print View Layout Fixes */
            #view-print {
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            #view-print > div:first-child { display: none !important; } /* Hide Form */
            
            /* Target the Receipt Wrapper */
            #view-print > div:last-child { 
                display: block !important; 
                width: 100% !important; 
                padding: 0 !important; 
                margin: 0 !important; 
                background: transparent !important;
                min-height: auto !important;
            }
            
            /* Receipt Container: Add safe padding to prevent cutting */
            .receipt-container { 
                width: 100% !important; 
                max-width: 100% !important; 
                box-shadow: none; 
                margin: 0 !important; 
                /* Added padding-right specifically to save the 'Amount' column */
                padding: 0 4mm 0 2mm !important; 
                border: none; 
                box-sizing: border-box !important;
            }

            /* Ensure table fits within the safe area */
            table { width: 100% !important; }

            @page { margin: 0; size: auto; }
            * { -webkit-print-color-adjust: exact; }
        }

        /* Tabs & UI */
        .tab-btn { cursor: pointer; padding: 10px 20px; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4">

    <!-- MAIN NAVIGATION -->
    <div class="w-full px-4 mb-4 bg-white rounded-lg shadow p-2 flex no-print">
        <div id="tab-print" class="tab-btn active" onclick="switchTab('print')">Print Bill</div>
        <div id="tab-history" class="tab-btn" onclick="switchTab('history')">History</div>
    </div>

    <!-- TAB 1: PRINT BILL -->
    <div id="view-print" class="w-full px-4 flex flex-col md:flex-row gap-8">
        <!-- FORM -->
        <div class="w-full md:w-1/2 bg-white p-6 rounded-lg shadow-md no-print">
            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">New Bill</h2>
            <div class="space-y-3 mb-6">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-600">Customer Name</label>
                    <input type="text" id="in_name" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter Name" oninput="updatePreview()">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-600">Phone Number (11 Digits)</label>
                    <input type="number" id="in_phone" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="017xxxxxxxx" 
                           oninput="if(this.value.length > 11) this.value = this.value.slice(0, 11); validatePhone()">
                    <p id="phone-error" class="text-red-500 text-xs mt-1 hidden">Number must be exactly 11 digits.</p>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-600">Address</label>
                    <textarea id="in_address" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" rows="2" placeholder="Enter Address" oninput="updatePreview()"></textarea>
                </div>
            </div>

            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">Products</h3>
                    <button onclick="addProductRow()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm font-bold hover:bg-blue-200">+ Add Item</button>
                </div>
                <div id="product-inputs" class="space-y-2"></div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-600">Shipping (Tk)</label>
                    <input type="number" id="in_shipping" class="w-full border p-2 rounded font-bold text-right" value="0" oninput="calculateTotals()">
                </div>
                <div class="flex items-end">
                    <div class="text-right w-full">
                        <div class="text-xs text-gray-500">Total Amount</div>
                        <div class="text-2xl font-black text-gray-800"><span id="screen-total">0</span> Tk</div>
                    </div>
                </div>
            </div>

            <button id="btn-print" onclick="processAndPrint()" class="w-full bg-black hover:bg-gray-800 text-white font-bold py-4 rounded-lg shadow-lg flex justify-center items-center gap-2 text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                PRINT & SAVE
            </button>
        </div>

        <!-- RECEIPT PREVIEW -->
        <div class="w-full md:w-1/2 flex justify-center items-start bg-gray-300 p-4 rounded-lg min-h-[500px]">
            <div id="receipt-area" class="receipt-container receipt-font">
                
                <div class="shop-header">
                    <div class="shop-name">PFF PREMIUM (ZS Trading)</div>
                    <div class="shop-details">#5/A, Satmasjid Road Dhanmondi, Dhaka</div>
                    <div class="shop-details">Mobile: 01772396719</div>
                </div>

                <div class="info-row" style="margin-top: 8px;">
                    <span>Date: <span id="out_date_only"></span> <span id="out_time_only"></span></span>
                </div>
                <div class="info-row">
                    <span>Sale Receipt: <span id="out_invoice"></span></span>
                </div>

                <div class="customer-section">
                    <div><span class="customer-label">Customer Name:</span> <span id="out_name">Walk-in</span></div>
                    <div><span class="customer-label">Mobile:</span> <span id="out_phone"></span></div>
                    <div><span class="customer-label">Customer Address:</span> <span id="out_address">Dhaka</span></div>
                </div>

                <table class="mb-2">
                    <thead>
                        <tr class="table-header">
                            <td class="text-left" style="width: 45%;">Description</td>
                            <td class="text-center" style="width: 15%;">Quantity</td>
                            <td class="text-right" style="width: 20%;">Price</td>
                            <td class="text-right" style="width: 20%;">Amount</td>
                        </tr>
                    </thead>
                    <tbody id="receipt-items"></tbody>
                </table>

                <div class="totals-section">
                    <div class="flex justify-between mb-1"><span>Sub Total</span><span><span id="out_subtotal">0</span>.00</span></div>
                    <div class="flex justify-between mb-1"><span>Delivery Charges</span><span><span id="out_shipping">0</span>.00</span></div>
                    
                    <div class="flex justify-between font-bold" style="border-top: 1px solid #000; margin-top: 2px; padding-top: 2px; font-size: 12px;">
                        <span>Total Due</span><span><span id="out_grandtotal">0</span>.00</span>
                    </div>
                </div>

                <div class="footer-msg">
                    We dont have any exchange or return policy.<br>
                    please check while receiving.<br><br>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: HISTORY -->
    <div id="view-history" class="w-full px-4 bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 border-b pb-2 gap-4">
            <h2 class="text-xl font-bold text-gray-800">Sales History</h2>
            <div class="relative w-full md:w-1/3">
                <input type="text" id="search-history" onkeyup="filterHistory()" class="block w-full p-2 text-sm border rounded" placeholder="Search Invoice, Name or Phone...">
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <th class="px-2 py-3">Date</th>
                        <th class="px-2 py-3">Invoice</th>
                        <th class="px-2 py-3">Customer</th>
                        <th class="px-2 py-3">Phone</th>
                        <th class="px-2 py-3 w-1/5 break-words">Address</th>
                        <th class="px-2 py-3 w-1/5 break-words">Items</th>
                        <th class="px-2 py-3 text-center">Total Qty</th>
                        <th class="px-2 py-3 text-right">Total</th>
                        <th class="px-2 py-3 text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="history-table-body"></tbody>
            </table>
            <div id="loading-msg" class="text-center py-8 hidden">Loading...</div>
            <div id="empty-history" class="text-center py-8 hidden">No records found.</div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwb7-0ACz3al6HlXpqrUz8JkfN5F5SuRQTZBUDz16HeXFpevV809fyhjMYdD_-dufWjLw/exec"; 

        // --- GLOBAL STATE ---
        let products = [{ id: 1, name: '', qty: 1, price: 0 }];
        let currentInvoiceId = getNextInvoiceId();
        let allHistoryData = []; 

        window.onload = function() {
            renderInputRows();
            updateDate();
        }

        function getNextInvoiceId() {
            let lastInv = localStorage.getItem('last_invoice_number');
            return lastInv ? parseInt(lastInv) + 1 : 1001;
        }

        function incrementInvoiceId() {
            localStorage.setItem('last_invoice_number', currentInvoiceId);
            currentInvoiceId++;
            document.getElementById('out_invoice').innerText = currentInvoiceId;
        }

        function updateDate() {
            const now = new Date();
            document.getElementById('out_date_only').innerText = now.toLocaleDateString('en-US'); 
            document.getElementById('out_time_only').innerText = "Time: " + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
            document.getElementById('out_invoice').innerText = currentInvoiceId;
        }

        function switchTab(tabName) {
            document.getElementById('view-print').classList.add('hidden');
            document.getElementById('view-history').classList.add('hidden');
            document.getElementById('tab-print').classList.remove('active');
            document.getElementById('tab-history').classList.remove('active');

            if(tabName === 'print') {
                document.getElementById('view-print').classList.remove('hidden');
                document.getElementById('view-print').classList.add('flex');
                document.getElementById('tab-print').classList.add('active');
                updatePreview();
                renderReceiptItems();
            } else {
                document.getElementById('view-history').classList.remove('hidden');
                document.getElementById('tab-history').classList.add('active');
                fetchHistory(); 
            }
        }

        function fetchHistory() {
            const tbody = document.getElementById('history-table-body');
            const loading = document.getElementById('loading-msg');
            const empty = document.getElementById('empty-history');
            
            tbody.innerHTML = '';
            loading.classList.remove('hidden');
            empty.classList.add('hidden');

            fetch(GOOGLE_SCRIPT_URL)
                .then(response => response.json())
                .then(data => {
                    loading.classList.add('hidden');
                    allHistoryData = data; 
                    renderHistoryTable(data);
                })
                .catch(err => {
                    console.error("Error:", err);
                    loading.innerHTML = "<span class='text-red-500'>Failed to load.</span>";
                });
        }

        function renderHistoryTable(data) {
            const tbody = document.getElementById('history-table-body');
            const empty = document.getElementById('empty-history');
            tbody.innerHTML = '';

            if(data.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50 align-top"; 
                const rowDataStr = JSON.stringify(row).replace(/"/g, '&quot;');
                
                let tQty = row.totalQty;
                if(tQty === undefined) { tQty = 0; }

                tr.innerHTML = `
                    <td class="px-2 py-2 whitespace-nowrap">${row.date.split(' ')[0]}</td>
                    <td class="px-2 py-2 font-mono text-xs font-bold">${row.invoice}</td>
                    <td class="px-2 py-2 font-bold">${row.customer}</td>
                    <td class="px-2 py-2">${row.phone.replace(/'/g, '')}</td>
                    <td class="px-2 py-2 text-xs">${row.address}</td>
                    <td class="px-2 py-2 text-xs">${row.items}</td>
                    <td class="px-2 py-2 text-center font-bold text-blue-600">${tQty}</td>
                    <td class="px-2 py-2 text-right font-bold">${row.total}</td>
                    <td class="px-2 py-2 text-center">
                        <button onclick="reprintBill(${rowDataStr})" class="bg-blue-100 text-blue-600 p-1 rounded hover:bg-blue-200 text-xs font-bold">Print</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterHistory() {
            const query = document.getElementById('search-history').value.toLowerCase();
            const filteredData = allHistoryData.filter(item => {
                return (
                    item.invoice.toString().toLowerCase().includes(query) ||
                    item.customer.toLowerCase().includes(query) ||
                    item.phone.toString().includes(query)
                );
            });
            renderHistoryTable(filteredData);
        }

        function reprintBill(data) {
            document.getElementById('out_invoice').innerText = data.invoice;
            document.getElementById('out_date_only').innerText = data.date; 
            document.getElementById('out_time_only').innerText = ""; 

            document.getElementById('out_name').innerText = data.customer;
            document.getElementById('out_phone').innerText = data.phone.replace(/'/g, '');
            document.getElementById('out_address').innerText = data.address;
            
            const tbody = document.getElementById('receipt-items');
            tbody.innerHTML = '';
            
            let itemsToRender = [];
            if (data.rawItems) {
                try {
                    itemsToRender = JSON.parse(data.rawItems);
                } catch(e) {}
            }

            if (itemsToRender.length > 0) {
                itemsToRender.forEach(prod => {
                    if(prod.name) {
                        const amount = prod.qty * prod.price;
                        const tr = document.createElement('tr');
                        tr.className = "item-row";
                        tr.innerHTML = `
                            <td class="text-left">${prod.name}</td>
                            <td class="text-center">${prod.qty}.00</td>
                            <td class="text-right">${Number(prod.price).toFixed(2)}</td>
                            <td class="text-right">${amount.toFixed(2)}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                });
            } else {
                const itemsArr = data.items.split(', ');
                itemsArr.forEach(itemStr => {
                    const parts = itemStr.split(' (');
                    if(parts.length > 1) {
                         const name = parts[0];
                         const qty = parts[1].replace(')', '');
                         const tr = document.createElement('tr');
                         tr.className = "item-row";
                         tr.innerHTML = `
                            <td class="text-left">${name}</td>
                            <td class="text-center">${qty}.00</td>
                            <td class="text-right">-</td>
                            <td class="text-right">-</td>
                        `;
                        tbody.appendChild(tr);
                    }
                });
            }

            document.getElementById('out_subtotal').innerText = "-"; 
            document.getElementById('out_shipping').innerText = "-"; 
            document.getElementById('out_grandtotal').innerText = data.total + ".00";

            document.body.classList.add('printing-history');
            setTimeout(() => {
                window.print();
                setTimeout(() => {
                    document.body.classList.remove('printing-history');
                }, 500);
            }, 100);
        }

        function validatePhone() {
            const phoneInput = document.getElementById('in_phone');
            const errorMsg = document.getElementById('phone-error');
            const btn = document.getElementById('btn-print');
            const val = phoneInput.value.toString();
            if (val.length !== 11 && val.length > 0) {
                errorMsg.classList.remove('hidden');
                phoneInput.classList.add('border-red-500');
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                return false;
            } else {
                errorMsg.classList.add('hidden');
                phoneInput.classList.remove('border-red-500');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                return true;
            }
        }
        function addProductRow() { products.push({ id: Date.now(), name: '', qty: 1, price: 0 }); renderInputRows(); }
        function removeRow(index) { products.splice(index, 1); renderInputRows(); }
        function renderInputRows() {
            const container = document.getElementById('product-inputs');
            container.innerHTML = '';
            products.forEach((prod, index) => {
                const row = document.createElement('div');
                row.className = "flex gap-2 items-end bg-gray-50 p-2 rounded border border-gray-200";
                row.innerHTML = `<div class="flex-grow"><input type="text" class="w-full p-1 bg-transparent border-b border-gray-300 text-sm outline-none" placeholder="Product Name" value="${prod.name}" oninput="updateProduct(${index}, 'name', this.value)"></div><div class="w-16"><input type="number" class="w-full p-1 bg-transparent border-b border-gray-300 text-sm text-center outline-none" value="${prod.qty}" min="1" oninput="updateProduct(${index}, 'qty', this.value)"></div><div class="w-20"><input type="number" class="w-full p-1 bg-transparent border-b border-gray-300 text-sm text-right outline-none" placeholder="Price" value="${prod.price}" oninput="updateProduct(${index}, 'price', this.value)"></div><button onclick="removeRow(${index})" class="text-red-400 hover:text-red-600 font-bold px-1">Ã—</button>`;
                container.appendChild(row);
            });
            calculateTotals();
        }
        function updateProduct(index, field, value) { products[index][field] = field === 'name' ? value : Number(value); renderReceiptItems(); calculateTotals(); }
        function renderReceiptItems() {
            const tbody = document.getElementById('receipt-items');
            tbody.innerHTML = '';
            products.forEach(prod => {
                if(prod.name || prod.price > 0) { 
                    const amount = prod.qty * prod.price;
                    const tr = document.createElement('tr');
                    tr.className = "item-row";
                    tr.innerHTML = `<td class="text-left">${prod.name}</td><td class="text-center">${prod.qty}.00</td><td class="text-right">${Number(prod.price).toFixed(2)}</td><td class="text-right">${amount.toFixed(2)}</td>`;
                    tbody.appendChild(tr);
                }
            });
        }
        function calculateTotals() {
            let subtotal = 0; products.forEach(p => { subtotal += (p.qty * p.price); });
            const shipping = Number(document.getElementById('in_shipping').value) || 0;
            const grandTotal = subtotal + shipping;
            document.getElementById('out_subtotal').innerText = subtotal.toFixed(2);
            document.getElementById('out_shipping').innerText = shipping.toFixed(2);
            document.getElementById('out_grandtotal').innerText = grandTotal.toFixed(2);
            document.getElementById('screen-total').innerText = grandTotal;
            return { subtotal, shipping, grandTotal };
        }
        async function processAndPrint() {
            if(!validatePhone()) { alert("Please correct the phone number"); return; }
            const totals = calculateTotals();
            const billData = {
                invoice: currentInvoiceId,
                date: new Date().toLocaleDateString('en-GB') + " " + new Date().toLocaleTimeString(),
                customer: document.getElementById('in_name').value || 'Walk-in',
                phone: document.getElementById('in_phone').value,
                address: document.getElementById('in_address').value,
                items: JSON.stringify(products),
                total: totals.grandTotal
            };
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(billData) }).catch(err => console.error(err));
            window.print();
            incrementInvoiceId();
        }
        function updatePreview() {
            document.getElementById('out_name').innerText = document.getElementById('in_name').value || "Walk-in";
            document.getElementById('out_phone').innerText = document.getElementById('in_phone').value;
            document.getElementById('out_address').innerText = document.getElementById('in_address').value || "Dhaka";
        }
    </script>
</body>
</html>
