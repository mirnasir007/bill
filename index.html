<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFF POS System</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General Styles */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }

        /* --- SCREEN PREVIEW STYLES --- */
        .receipt-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            font-size: 14px;
        }

        /* --- PRINT STYLES --- */
        #print-only-area { display: none; }

        @media print {
            /* Reset Page Margins for POS */
            @page { margin: 0; size: auto; }
            body { background: white; margin: 0; padding: 0; }
            
            .no-print { display: none !important; }
            #view-print, #view-history, .tab-btn { display: none !important; }
            
            /* Main Print Container */
            #print-only-area { 
                display: block !important; 
                width: 100%;
                /* Standard POS Padding */
                padding: 5mm 3mm; 
                box-sizing: border-box;
                font-family: Arial, sans-serif;
                color: black;
                font-size: 12px;
            }

            /* Header Section */
            .print-header { text-align: center; margin-bottom: 15px; }
            .print-shop-name { font-weight: 900; font-size: 17px; text-transform: uppercase; margin-bottom: 3px; }
            .print-address { font-size: 11px; margin-bottom: 2px; }
            .print-contact { font-size: 12px; font-weight: bold; }

            /* Customer & Invoice Info Table */
            .info-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 10px;
            }
            .info-table td {
                padding: 2px 0;
                vertical-align: top;
                font-size: 12px;
            }
            /* Column 1: Labels */
            .info-label-col {
                width: 130px; 
                font-weight: 900;
                white-space: nowrap;
            }
            /* Column 2: Values */
            .info-value-col {
                text-align: left;
                padding-left: 5px;
            }

            /* Product Table */
            .print-table { 
                width: 100%; 
                border-collapse: collapse; 
                margin-top: 5px; 
                font-size: 12px;
                border-top: 2px solid black; 
            }
            .print-table th { 
                border-bottom: 2px solid black; 
                text-align: left; 
                padding: 5px 0;
                font-weight: 900;
            }
            .print-table td { 
                padding: 4px 0; 
                vertical-align: top;
            }
            .text-right { text-align: right; }
            .text-center { text-align: center; }

            /* Totals Section */
            .print-totals { 
                margin-top: 5px; 
                border-top: 1px solid #000; 
                padding-top: 5px;
                font-size: 12px;
            }
            .total-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
            
            /* Grand Total Style */
            .grand-total {
                border-top: 2px solid black;
                margin-top: 5px;
                padding-top: 5px;
                font-weight: 900;
                font-size: 14px;
            }

            /* Footer */
            .print-footer { 
                text-align: center; 
                font-size: 11px; 
                margin-top: 25px; 
                border-top: 1px solid #ddd;
                padding-top: 10px;
            }
        }
    </style>
</head>
<body class="p-4">

    <div class="w-full px-4 mb-4 bg-white rounded-lg shadow p-2 flex no-print">
        <div id="tab-print" class="tab-btn active text-blue-600 border-b-2 border-blue-600 font-bold px-4 py-2" onclick="switchTab('print')">Print Bill</div>
        <div id="tab-history" class="tab-btn text-gray-500 px-4 py-2 font-bold cursor-pointer hover:text-blue-500" onclick="switchTab('history')">History</div>
    </div>

    <div id="view-print" class="w-full px-4 flex flex-col md:flex-row gap-8">
        <div class="w-full md:w-1/2 bg-white p-6 rounded-lg shadow-md no-print">
            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">New Bill</h2>
            
            <div class="space-y-3 mb-6">
                <div class="flex gap-2">
                    <div class="w-1/2">
                        <label class="block text-xs font-bold uppercase text-gray-600">Invoice No (Optional)</label>
                        <input type="text" id="in_invoice_custom" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-yellow-50" placeholder="Auto" oninput="updatePreview()">
                    </div>
                    <div class="w-1/2">
                        <label class="block text-xs font-bold uppercase text-gray-600">Date</label>
                        <input type="text" disabled id="display_date" class="w-full border p-2 rounded bg-gray-100 text-gray-500 font-bold">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase text-gray-600">Phone Number</label>
                    <div class="flex gap-2">
                        <input type="number" id="in_phone" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="017xxxxxxxx" 
                               oninput="validatePhone()" onkeydown="if(event.key === 'Enter') checkCustomer()">
                        <button id="btn-search" onclick="checkCustomer()" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 font-bold min-w-[50px] flex justify-center items-center">
                            <svg id="icon-search" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            <div id="icon-loading" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
                        </button>
                    </div>
                    <p id="phone-error" class="text-red-500 text-xs mt-1 hidden">Number must be 11 digits.</p>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase text-gray-600">Customer Name</label>
                    <input type="text" id="in_name" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter Name" oninput="updatePreview()">
                </div>
                
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-600">Address</label>
                    <textarea id="in_address" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" rows="2" placeholder="Enter Address" oninput="updatePreview()"></textarea>
                </div>
            </div>

            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">Products</h3>
                    <button onclick="addProductRow()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm font-bold hover:bg-blue-200">+ Add Item</button>
                </div>
                <div id="product-inputs" class="space-y-2"></div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-600">Shipping (Tk)</label>
                    <input type="number" id="in_shipping" class="w-full border p-2 rounded font-bold text-right" value="0" oninput="calculateTotals()">
                </div>
                <div class="flex items-end">
                    <div class="text-right w-full">
                        <div class="text-xs text-gray-500">Total Amount</div>
                        <div class="text-2xl font-black text-gray-800"><span id="screen-total">0</span> Tk</div>
                    </div>
                </div>
            </div>

            <button id="btn-print" onclick="processAndPrint()" class="w-full bg-black hover:bg-gray-800 text-white font-bold py-4 rounded-lg shadow-lg flex justify-center items-center gap-2 text-lg transition transform hover:scale-[1.02]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2-2H9a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                PRINT & SAVE
            </button>
        </div>

        <div class="w-full md:w-1/2 flex justify-center items-start bg-gray-300 p-4 rounded-lg min-h-[500px] no-print">
            <div class="receipt-card">
                <div class="text-center font-bold text-lg mb-2 text-gray-700">PREVIEW</div>
                <div class="border-b mb-4"></div>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm"><span>Invoice:</span> <span id="prev_invoice" class="font-bold"></span></div>
                    <div class="flex justify-between text-sm"><span>Customer:</span> <span id="prev_name"></span></div>
                    <div class="flex justify-between text-sm pt-2 border-t"><span>Total:</span> <span id="prev_total" class="font-bold text-lg">0</span></div>
                </div>
                <div class="mt-8 text-xs text-center text-gray-400 border-2 border-dashed p-4 rounded bg-gray-50">
                    <p>Click "Print & Save" to see the full official invoice.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="print-only-area">
        <div class="print-header">
            <div class="print-shop-name">PFF PREMIUM (ZS TRADING)</div>
            <div class="print-address">#5/A, Satmasjid Road Dhanmondi, Dhaka</div>
            <div class="print-contact">Mobile: 01772396719</div>
        </div>

        <table class="info-table">
            <tr>
                <td class="info-label-col">Date:</td>
                <td class="info-value-col"><span id="print_date"></span></td>
            </tr>
            <tr>
                <td class="info-label-col">Invoice NO:</td>
                <td class="info-value-col"><span id="print_invoice"></span></td>
            </tr>
            <tr>
                <td class="info-label-col">Customer Name:</td>
                <td class="info-value-col"><span id="print_name"></span></td>
            </tr>
            <tr>
                <td class="info-label-col">Mobile:</td>
                <td class="info-value-col"><span id="print_phone"></span></td>
            </tr>
            <tr>
                <td class="info-label-col">Customer Address:</td>
                <td class="info-value-col"><span id="print_address"></span></td>
            </tr>
        </table>

        <table class="print-table">
            <thead>
                <tr>
                    <th style="width: 40%;">Description</th>
                    <th class="text-center" style="width: 15%;">Quantity</th>
                    <th class="text-right" style="width: 20%;">Price</th>
                    <th class="text-right" style="width: 25%;">Amount</th>
                </tr>
            </thead>
            <tbody id="print-items-body"></tbody>
        </table>

        <div class="print-totals">
            <div class="total-row">
                <span>Sub Total</span>
                <span><span id="print_subtotal">0.00</span></span>
            </div>
            <div class="total-row">
                <span>Delivery Charges</span>
                <span><span id="print_shipping">0.00</span></span>
            </div>
            <div class="total-row grand-total">
                <span>Total Due</span>
                <span><span id="print_grandtotal">0.00</span></span>
            </div>
        </div>

        <div class="print-footer">
            We dont have any exchange or return policy.<br>
            please check while receiving.
        </div>
    </div>

    <div id="view-history" class="w-full px-4 bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 border-b pb-2 gap-4">
            <h2 class="text-xl font-bold text-gray-800">Sales History</h2>
            <div class="relative w-full md:w-1/3">
                <input type="text" id="search-history" onkeyup="filterHistory()" class="block w-full p-2 text-sm border rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Search Invoice, Name or Phone...">
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <th class="px-2 py-3">Date</th>
                        <th class="px-2 py-3">Invoice</th>
                        <th class="px-2 py-3">Customer</th>
                        <th class="px-2 py-3">Phone</th>
                        <th class="px-2 py-3 min-w-[200px] whitespace-normal">Address</th>
                        <th class="px-2 py-3">Items</th>
                        <th class="px-2 py-3 text-right">Total</th>
                        <th class="px-2 py-3 text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="history-table-body"></tbody>
            </table>
            <div id="loading-msg" class="text-center py-8 hidden text-blue-500 font-bold">Loading...</div>
        </div>
    </div>

    <div id="modal-new-customer" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">New Customer</p>
                    <div class="modal-close cursor-pointer z-50 hover:text-red-500" onclick="toggleModal('modal-new-customer')">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <div class="my-5">
                    <p class="mb-4 text-gray-600 text-sm">Customer not found. Please enter details to save.</p>
                    <label class="block text-xs font-bold mb-1">Phone</label>
                    <input type="text" id="modal_phone" class="w-full border p-2 mb-2 bg-gray-100 rounded" readonly>
                    <label class="block text-xs font-bold mb-1">Name</label>
                    <input type="text" id="modal_name" class="w-full border p-2 mb-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    <label class="block text-xs font-bold mb-1">Address</label>
                    <textarea id="modal_address" class="w-full border p-2 mb-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" rows="2"></textarea>
                </div>
                <div class="flex justify-end pt-2">
                    <button onclick="toggleModal('modal-new-customer')" class="px-4 py-2 rounded-lg text-gray-500 hover:bg-gray-100 mr-2 font-bold">Cancel</button>
                    <button onclick="saveCustomerToSheet()" class="px-4 py-2 bg-blue-600 rounded-lg text-white hover:bg-blue-700 font-bold">Save Customer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwb7-0ACz3al6HlXpqrUz8JkfN5F5SuRQTZBUDz16HeXFpevV809fyhjMYdD_-dufWjLw/exec"; 

        // --- GLOBAL STATE ---
        let products = [{ id: 1, name: '', qty: 1, price: 0 }];
        let currentInvoiceId = getNextInvoiceId();
        let allHistoryData = []; 

        window.onload = function() {
            renderInputRows();
            updateDate();
        }

        function formatDateToLong(inputDate) {
            try {
                let d;
                // Handle different incoming formats
                if (typeof inputDate === 'string') {
                    if (inputDate.includes('/')) {
                        const parts = inputDate.split(' ')[0].split('/'); 
                        if (parts.length === 3) {
                            d = new Date(parts[2], parts[1] - 1, parts[0]);
                        } else {
                            return inputDate; 
                        }
                    } else {
                        // Attempt to parse ISO string
                        d = new Date(inputDate);
                        if (isNaN(d.getTime())) return inputDate;
                    }
                } else if (inputDate instanceof Date) {
                    d = inputDate;
                } else {
                    return inputDate;
                }
                return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
            } catch (e) {
                console.error("Date error", e);
                return inputDate;
            }
        }

        // --- INVOICE LOGIC ---
        function getNextInvoiceId() {
            let lastInv = localStorage.getItem('last_invoice_number');
            return lastInv ? parseInt(lastInv) + 1 : 1001;
        }

        function incrementInvoiceId() {
            localStorage.setItem('last_invoice_number', currentInvoiceId);
            currentInvoiceId++;
            document.getElementById('in_invoice_custom').value = ''; 
            document.getElementById('in_name').value = '';
            document.getElementById('in_phone').value = '';
            document.getElementById('in_address').value = '';
            document.getElementById('in_shipping').value = '0';
            products = [{ id: Date.now(), name: '', qty: 1, price: 0 }];
            renderInputRows();
            updatePreview();
        }

        function updateDate() {
            const now = new Date();
            const longDate = formatDateToLong(now);
            document.getElementById('display_date').value = longDate;
            
            const customInv = document.getElementById('in_invoice_custom').value;
            const invDisplay = customInv ? customInv : currentInvoiceId;
            document.getElementById('prev_invoice').innerText = invDisplay;
        }

        // --- CUSTOMER SEARCH & SAVE ---
        function checkCustomer() {
            const phone = document.getElementById('in_phone').value;
            if (phone.length < 11) { alert("Please enter valid phone"); return; }
            
            const btnIcon = document.getElementById('icon-search');
            const loader = document.getElementById('icon-loading');
            btnIcon.classList.add('hidden');
            loader.classList.remove('hidden');
            
            fetch(`${GOOGLE_SCRIPT_URL}?action=getCustomer&phone=${phone}`)
            .then(res => res.json())
            .then(data => {
                btnIcon.classList.remove('hidden');
                loader.classList.add('hidden');
                
                if(data.found) {
                    document.getElementById('in_name').value = data.name;
                    document.getElementById('in_address').value = data.address;
                    updatePreview();
                } else {
                    document.getElementById('modal_phone').value = phone;
                    document.getElementById('modal_name').value = "";
                    document.getElementById('modal_address').value = "";
                    toggleModal('modal-new-customer');
                    setTimeout(() => document.getElementById('modal_name').focus(), 100);
                }
            })
            .catch(err => {
                btnIcon.classList.remove('hidden');
                loader.classList.add('hidden');
                alert("Error connecting to database");
            });
        }

        function saveCustomerToSheet() {
            const phone = document.getElementById('modal_phone').value;
            const name = document.getElementById('modal_name').value;
            const address = document.getElementById('modal_address').value;

            if(!name || !address) { alert("Fill all fields"); return; }

            document.getElementById('in_name').value = name;
            document.getElementById('in_address').value = address;
            updatePreview();
            toggleModal('modal-new-customer');

            const url = `${GOOGLE_SCRIPT_URL}?action=saveCustomer&phone=${phone}&name=${encodeURIComponent(name)}&address=${encodeURIComponent(address)}`;
            fetch(url).then(res => res.json()).then(d => console.log("Saved"));
        }

        function toggleModal(modalID) {
            const modal = document.getElementById(modalID);
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');
        }

        // --- PRINT & PROCESS ---
        function preparePrintData(invoice, dateStr) {
            document.getElementById('print_invoice').innerText = invoice;
            document.getElementById('print_date').innerText = dateStr;
            document.getElementById('print_name').innerText = document.getElementById('in_name').value || 'Walk-in';
            document.getElementById('print_phone').innerText = document.getElementById('in_phone').value;
            document.getElementById('print_address').innerText = document.getElementById('in_address').value;

            const tbody = document.getElementById('print-items-body');
            tbody.innerHTML = '';
            products.forEach(prod => {
                if(prod.name || prod.price > 0) {
                    const amount = prod.qty * prod.price;
                    tbody.innerHTML += `
                        <tr>
                            <td>${prod.name}</td>
                            <td class="text-center">${prod.qty}.00</td>
                            <td class="text-right">${Number(prod.price).toFixed(2)}</td>
                            <td class="text-right">${amount.toFixed(2)}</td>
                        </tr>
                    `;
                }
            });
            
            const totals = calculateTotals();
            document.getElementById('print_subtotal').innerText = totals.subtotal.toFixed(2);
            document.getElementById('print_shipping').innerText = totals.shipping.toFixed(2);
            document.getElementById('print_grandtotal').innerText = totals.grandTotal.toFixed(2);
            
            return totals.grandTotal;
        }

        async function processAndPrint() {
            if(!validatePhone()) { alert("Please correct the phone number"); return; }
            
            const now = new Date();
            const dateStrForPrint = formatDateToLong(now);
            
            // MANUAL DATE FORMATTING FOR SHEET (dd/MM/yyyy)
            // This ensures 4th Jan is always 04/01/2026 regardless of browser locale
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const dateStrForSheet = `${day}/${month}/${year}`;

            const customInv = document.getElementById('in_invoice_custom').value;
            const finalInvoice = customInv ? customInv : currentInvoiceId;

            const grandTotal = preparePrintData(finalInvoice, dateStrForPrint);

            const billData = {
                invoice: finalInvoice,
                date: dateStrForSheet, // Sending strict dd/MM/yyyy string
                customer: document.getElementById('in_name').value || 'Walk-in',
                phone: document.getElementById('in_phone').value,
                address: document.getElementById('in_address').value,
                items: JSON.stringify(products),
                total: grandTotal
            };
            
            fetch(GOOGLE_SCRIPT_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(billData) 
            }).catch(err => console.error(err));

            window.print();
            
            if (!customInv) {
                incrementInvoiceId(); 
            } else {
                document.getElementById('in_invoice_custom').value = ''; 
                document.getElementById('in_name').value = '';
                document.getElementById('in_phone').value = '';
                document.getElementById('in_address').value = '';
                products = [{ id: Date.now(), name: '', qty: 1, price: 0 }];
                renderInputRows();
                updatePreview();
            }
        }

        function reprintBill(data) {
            document.getElementById('print_invoice').innerText = data.invoice;
            // Clean up the date string (remove leading ' if exists)
            const cleanDate = String(data.date).replace(/'/g, '');
            document.getElementById('print_date').innerText = formatDateToLong(cleanDate);
            document.getElementById('print_name').innerText = data.customer;
            document.getElementById('print_phone').innerText = data.phone.replace(/'/g, '');
            document.getElementById('print_address').innerText = data.address;
            
            const tbody = document.getElementById('print-items-body');
            tbody.innerHTML = '';
            
            let itemsToRender = [];
            if (data.rawItems) { try { itemsToRender = JSON.parse(data.rawItems); } catch(e) {} }

            if (itemsToRender.length > 0) {
                itemsToRender.forEach(prod => {
                    if(prod.name) {
                        const amount = prod.qty * prod.price;
                        tbody.innerHTML += `
                            <tr>
                                <td>${prod.name}</td>
                                <td class="text-center">${prod.qty}.00</td>
                                <td class="text-right">${Number(prod.price).toFixed(2)}</td>
                                <td class="text-right">${amount.toFixed(2)}</td>
                            </tr>
                        `;
                    }
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="4">Legacy Data</td></tr>`;
            }

            document.getElementById('print_subtotal').innerText = "0.00"; 
            document.getElementById('print_shipping').innerText = "0.00"; 
            document.getElementById('print_grandtotal').innerText = Number(data.total).toFixed(2);

            document.body.classList.add('printing-history');
            setTimeout(() => {
                window.print();
                setTimeout(() => { document.body.classList.remove('printing-history'); }, 500);
            }, 100);
        }

        // --- STANDARD FUNCTIONS ---
        function switchTab(tabName) {
            document.getElementById('view-print').classList.add('hidden');
            document.getElementById('view-history').classList.add('hidden');
            // Reset colors
            document.getElementById('tab-print').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('tab-print').classList.add('text-gray-500');
            
            document.getElementById('tab-history').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('tab-history').classList.add('text-gray-500');

            if(tabName === 'print') {
                document.getElementById('view-print').classList.remove('hidden');
                document.getElementById('view-print').classList.add('flex');
                document.getElementById('tab-print').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                document.getElementById('tab-print').classList.remove('text-gray-500');
                updatePreview();
            } else {
                document.getElementById('view-history').classList.remove('hidden');
                document.getElementById('tab-history').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                document.getElementById('tab-history').classList.remove('text-gray-500');
                fetchHistory(); 
            }
        }

        function fetchHistory() {
            const tbody = document.getElementById('history-table-body');
            document.getElementById('loading-msg').classList.remove('hidden');
            tbody.innerHTML = '';

            fetch(GOOGLE_SCRIPT_URL)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading-msg').classList.add('hidden');
                    allHistoryData = data; 
                    renderHistoryTable(data);
                });
        }

        function renderHistoryTable(data) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50 align-top transition hover:bg-blue-50"; 
                const rowDataStr = JSON.stringify(row).replace(/"/g, '&quot;');
                
                // Clean date for display
                const cleanDate = String(row.date).replace(/'/g, '');
                const displayDate = formatDateToLong(cleanDate);

                tr.innerHTML = `
                    <td class="px-2 py-2 whitespace-nowrap text-gray-700">${displayDate}</td>
                    <td class="px-2 py-2 font-mono text-xs font-bold text-gray-600">${row.invoice}</td>
                    <td class="px-2 py-2 font-bold text-gray-800">${row.customer}</td>
                    <td class="px-2 py-2 text-gray-600">${row.phone.replace(/'/g, '')}</td>
                    <td class="px-2 py-2 text-xs min-w-[200px] whitespace-normal text-gray-500">${row.address}</td>
                    <td class="px-2 py-2 text-xs text-gray-500">${row.items}</td>
                    <td class="px-2 py-2 text-right font-bold text-gray-800">${row.total}</td>
                    <td class="px-2 py-2 text-center">
                        <button onclick="reprintBill(${rowDataStr})" class="bg-blue-100 text-blue-600 p-1 px-2 rounded hover:bg-blue-200 text-xs font-bold">Print</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterHistory() {
            const query = document.getElementById('search-history').value.toLowerCase();
            const filteredData = allHistoryData.filter(item => {
                return (item.invoice.toString().toLowerCase().includes(query) || item.customer.toLowerCase().includes(query) || item.phone.toString().includes(query));
            });
            renderHistoryTable(filteredData);
        }

        function validatePhone() {
            const phoneInput = document.getElementById('in_phone');
            const btn = document.getElementById('btn-print');
            const val = phoneInput.value.toString();
            if (val.length !== 11 && val.length > 0) {
                document.getElementById('phone-error').classList.remove('hidden');
                phoneInput.classList.add('border-red-500');
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                return false;
            } else {
                document.getElementById('phone-error').classList.add('hidden');
                phoneInput.classList.remove('border-red-500');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                return true;
            }
        }
        function addProductRow() { products.push({ id: Date.now(), name: '', qty: 1, price: 0 }); renderInputRows(); }
        function removeRow(index) { products.splice(index, 1); renderInputRows(); }
        function renderInputRows() {
            const container = document.getElementById('product-inputs');
            container.innerHTML = '';
            products.forEach((prod, index) => {
                const row = document.createElement('div');
                row.className = "flex gap-2 items-end bg-gray-50 p-2 rounded border border-gray-200";
                row.innerHTML = `<div class="flex-grow"><input type="text" class="w-full p-1 bg-transparent border-b border-gray-300 text-sm outline-none focus:border-blue-500" placeholder="Product Name" value="${prod.name}" oninput="updateProduct(${index}, 'name', this.value)"></div><div class="w-16"><input type="number" class="w-full p-1 bg-transparent border-b border-gray-300 text-sm text-center outline-none focus:border-blue-500" value="${prod.qty}" min="1" oninput="updateProduct(${index}, 'qty', this.value)"></div><div class="w-20"><input type="number" class="w-full p-1 bg-transparent border-b border-gray-300 text-sm text-right outline-none focus:border-blue-500" placeholder="Price" value="${prod.price}" oninput="updateProduct(${index}, 'price', this.value)"></div><button onclick="removeRow(${index})" class="text-red-400 hover:text-red-600 font-bold px-1 transition transform hover:scale-110">Ã—</button>`;
                container.appendChild(row);
            });
            calculateTotals();
        }
        function updateProduct(index, field, value) { products[index][field] = field === 'name' ? value : Number(value); calculateTotals(); }
        function calculateTotals() {
            let subtotal = 0; products.forEach(p => { subtotal += (p.qty * p.price); });
            const shipping = Number(document.getElementById('in_shipping').value) || 0;
            const grandTotal = subtotal + shipping;
            document.getElementById('screen-total').innerText = grandTotal;
            document.getElementById('prev_total').innerText = grandTotal;
            return { subtotal, shipping, grandTotal };
        }
        function updatePreview() {
            document.getElementById('prev_name').innerText = document.getElementById('in_name').value || '...';
            const customInv = document.getElementById('in_invoice_custom').value;
            const invDisplay = customInv ? customInv : currentInvoiceId;
            document.getElementById('prev_invoice').innerText = invDisplay;
        }
    </script>
</body>
</html>
